---
title: "CVE-2021-1675"
description: "Microsoft Windows Print Spooler allows for RCE via AddPrinterDriverEx()"
vulnid: "383432"
draft: false
toc: true
vendors: ['Microsoft']
---
### Solution

#### Apply an update

Microsoft has addressed this issue in the [updates for CVE-2021-34527](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527). Note that the Microsoft update for CVE-2021-34527 does not effectively prevent exploitation of systems where the [Point and Print](https://docs.microsoft.com/en-us/windows-hardware/drivers/print/introduction-to-point-and-print) `NoWarningNoElevationOnInstall` is set to a non-`0` value. Microsoft indicates that systems that have `NoWarningNoElevationOnInstall` is set to a non-`0` value are **vulnerable by design.** For systems that do not have the CVE-2021-34527 installed, or have Point and Print configured insecurely, please consider the following workarounds:

#### Apply a workaround

Microsoft has listed several workarounds in their [advisory for CVE-2021-34527](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527). Specifically:

#### Microsoft Option 1 - Stop and disable the Print Spooler service

This vulnerability can be mitigated by stopping and disabling the Print Spooler service in Windows.

If disabling the Print Spooler service is appropriate for your enterprise, use the following PowerShell commands:

`Stop-Service -Name Spooler -Force`

`Set-Service -Name Spooler -StartupType Disabled`

**Impact of workaround** Disabling the Print Spooler service disables the ability to print both locally and remotely.

#### Microsoft Option 2 - Disable inbound remote printing through Group Policy

Disable the “Allow Print Spooler to accept client connections:” policy to block remote attacks.

**Impact of workaround** This policy will block the remote attack vector by preventing inbound remote printing operations. The system will no longer function as a print server, but local printing to a directly attached device will still be possible.

**Note:** The Print Spooler service **must** be restarted for this workaround to be activated.

#### Block RPC and SMB ports at the firewall

Limited testing has shown that blocking both the RPC Endpoint Mapper (`135/tcp`) and SMB (`139/tcp` and `445/tcp`) incoming traffic at a host-based firewall level can prevent remote exploitation of this vulnerability. Note that blocking these ports on a Windows system may prevent expected capabilities from functioning properly, especially on a system that functions as a server.

#### Enable security prompts for Point and Print

Ensure that the Windows Point and Print Restrictions are set to `Show warning and elevation prompt` for both installing and updating drivers in the Windows Group Policy. Specifically the `HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint\` key should have `NoWarningNoElevationOnInstall` and `UpdatePromptSettings` entries that are both set to `0`.

#### Restrict printer driver installation ability to administrators

After the Microsoft update for CVE-2021-34527 is installed, a registry value called `RestrictDriverInstallationToAdministrators` in the `HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint\` key is checked, which is intended to restrict printer driver installation to only administrator users. Please see [KB5005010](https://support.microsoft.com/en-us/topic/kb5005010-restricting-installation-of-new-printer-drivers-after-applying-the-july-6-2021-updates-31b91c02-05bc-4ada-a7ea-183b129578a7) for more details.

### References

* <https://msrc-blog.microsoft.com/2021/07/08/clarified-guidance-for-cve-2021-34527-windows-print-spooler-vulnerability/>
* <https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-1675>
* <https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527>
* <https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-rprn/b96cc497-59e5-4510-ab04-5484993b259b>
* <https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-rprn/353ff796-6fb3-41cf-8b35-0022dd53d886>
* <https://docs.microsoft.com/en-us/windows-hardware/drivers/print/introduction-to-point-and-print>
* <https://docs.microsoft.com/en-us/windows/win32/printdocs/addprinterdriverex>
* <https://support.microsoft.com/en-us/topic/kb5005010-restricting-installation-of-new-printer-drivers-after-applying-the-july-6-2021-updates-31b91c02-05bc-4ada-a7ea-183b129578a7>
* <https://github.com/afwu/PrintNightmare>
* <https://github.com/cube0x0/CVE-2021-1675>
* <https://github.com/calebstewart/CVE-2021-1675>

* <https://www.kb.cert.org/vuls/id/383432>