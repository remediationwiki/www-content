---
title: "CVE-2021-36958"
description: "Microsoft Windows Print Spooler Point and Print allows installation of arbitrary queue-specific files"
vulnid: "131152"
draft: false
toc: true
vendors: ['Microsoft']
---
### Solution

Microsoft has published updates for [CVE-2021-36958](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-36958) regarding this issue. Please also consider the following workarounds:

#### Block outbound SMB traffic at your network boundary

Public exploits for this vulnerability utilize SMB for connectivity to a malicious shared printer. If outbound connections to SMB resources are blocked, then this vulnerability may be mitigated for malicious SMB printers that are hosted outside of your network. Note that an attacker local to your network would be able to share a printer via SMB, which would be unaffected by any outbound SMB traffic rules.

#### Configure both PackagePointAndPrintServerList and PackagePointAndPrintOnly settings

Microsoft Windows has a Group Policy called "Package Point and Print - Approved servers", which is reflected in the `HKLM\Software\Policies\Microsoft\Windows NT\Printers\PackagePointAndPrint\PackagePointAndPrintServerList` and `HKLM\Software\Policies\Microsoft\Windows NT\Printers\PackagePointAndPrint\ListofServers` registry values. This policy can restrict which servers can be used by non-administrative users to install printers via Point and Print. Configure this policy to prevent installation of printers from arbitrary servers.

To ensure that Microsoft Windows only attempts to install Package Point and Print printers, and therefore restricting printer connections to the approved servers list, you must also set the `HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PackagePointAndPrint\PackagePointAndPrintOnly` registry value to `1`. The Group Policy setting that corresponds to this value is called "Use only Package Point and print". Setting this value to "Enabled" will enforce that only Package Point and Print printers will be used.

**Both** of these settings must be configured to protect against exploitation of this vulnerability.

#### Block the ability to modify the print spooler drivers directory

Courtesy of the [TRUESEC Blog](https://blog.truesec.com/2021/06/30/fix-for-printnightmare-cve-2021-1675-exploit-to-keep-your-print-servers-running-while-a-patch-is-not-available/), this vulnerability can be mitigated by preventing the `SYSTEM` account from being able to modify the `C:\Windows\System32\spool\drivers` directory contents.

To enable this mitigation, from a privileged PowerShell session, run:
```
$Path = "C:\Windows\System32\spool\drivers"
$Acl = (Get-Item $Path).GetAccessControl('Access')
$Ar = New-Object  System.Security.AccessControl.FileSystemAccessRule("System", "Modify", "ContainerInherit, ObjectInherit", "None", "Deny")
$Acl.AddAccessRule($Ar)
Set-Acl $Path $Acl
```

To revert the mitigation to allow printer driver installation or modification, run:
```
$Path = "C:\Windows\System32\spool\drivers"
$Acl = (Get-Item $Path).GetAccessControl('Access')
$Ar = New-Object System.Security.AccessControl.FileSystemAccessRule("System", "Modify", "ContainerInherit, ObjectInherit", "None", "Deny")
$Acl.RemoveAccessRule($Ar)
Set-Acl $Path $Acl
```

#### Stop and disable the Print Spooler

The Print Spooler can be disabled in a privileged PowerShell session by running the following commands:
```
Stop-Service -Name Spooler -Force
Set-Service -Name Spooler -StartupType Disabled
```

**Impact of workaround** Disabling the Print Spooler service disables the ability to print both locally and remotely.

### References

* <https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-36958>
* <https://docs.microsoft.com/en-us/security-updates/securitybulletins/2016/ms16-087>
* <https://docs.microsoft.com/en-us/windows-hardware/drivers/print/introduction-to-point-and-print>
* <https://docs.microsoft.com/en-us/windows-hardware/drivers/install/whql-release-signature>
* <https://docs.microsoft.com/en-us/windows-hardware/drivers/print/installing-queue-specific-files>
* <https://twitter.com/gentilkiwi/status/1416429860566847490>
* <https://blog.truesec.com/2021/06/30/fix-for-printnightmare-cve-2021-1675-exploit-to-keep-your-print-servers-running-while-a-patch-is-not-available/>

* <https://www.kb.cert.org/vuls/id/131152>