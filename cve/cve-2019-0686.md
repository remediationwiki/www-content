---
title: "https://dirkjanm.io/abusing-exchange-one-api-call-away-from-domain-admin/"
description: "Microsoft Exchange server 2013 and newer are vulnerable to NTLM relay attacks"
vulnid: "465632"
draft: false
toc: true
vendors: ['Microsoft']
---
### Solution

|  |
| --- |
| **Apply an update**This issue is mitigated by the [Microsoft Exchange updates for CVE-2019-0686](https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2019-0686). This update will cause the Exchange server to not attempt NTLM authentication with hosts that it contacts as the result of a PushSubscriptionRequest API call. The versions of Exchange that contain this fix include:* Exchange Server 2010 Service Pack 3 Update Rollup 26
* Exchange Server 2013 Cumulative Update 22
* Exchange Server 2016 Cumulative Update 12
* Exchange Server 2019 Cumulative Update 1

These updates also include the [fix for CVE-2019-0724](https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2019-0724), which removes some of the unnecessary privileges that are granted to an Exchange server in a default installation. This is a defense-in-depth update that can help mitigate the impact of exploitation of this vulnerability.  |

|  |
| --- |
| **Disable EWS push/pull subscriptions**If you have an exchange server that does not leverage EWS push/pull subscriptions, you can block the PushSubscriptionRequest API call that triggers this attack. In an Exchange Management Shell window, execute the following commands:New-ThrottlingPolicy -Name NoEWSSubscription -ThrottlingPolicyScope Organization -EwsMaxSubscriptions 0Restart-WebAppPool -Name MSExchangeServicesAppPool
**Remove privileges that Exchange has on the domain object**Please note that the following workaround was not developed by CERT and is not supported by Microsoft. Please test any workarounds in your environment to ensure that they work properly.<https://github.com/gdedrouas/Exchange-AD-Privesc/blob/master/DomainObject/Fix-DomainObjectDACL.ps1> is a PowerShell script that can be executed on either the Exchange Server or Domain Controller system. By default this script will check for vulnerable access control entries in the current active directory. When executed with Domain Admin privileges and the -Fix flag, this script will remove the ability for Exchange to write to the domain object.Note that if you encounter an error about Get-ADDomainController not being recognized, you will need to install and import the ActiveDirectory PowerShell module, and then finally run Fix-DomainObjectDACL.ps1 :Import-Module ServerManagerAdd-WindowsFeature RSAT-AD-PowerShellImport-Module ActiveDirectory.\Fix-DomainObjectDACL.ps1
If the script reports that faulty ACE were found, run:.\Fix-DomainObjectDACL.ps1 -Fix
PowerShell may be configured to block the execution of user-provided .ps1 files. If this is the case, first find your current PowerShell execution policy:Get-ExecutionPolicy
Temporarily allow the execution of the Fix-DomainObjectDACL.ps1 script by running:Set-ExecutionPolicy unrestricted
Once you are finished running the Fix-DomainObjectDACL.ps1script, set the policy back to the original value as reported by Get-ExecutionPolicy:Set-ExecutionPolicy [POLICY]
**Consider additional workarounds**The [blog post for this vulnerability](https://dirkjanm.io/abusing-exchange-one-api-call-away-from-domain-admin/) contains several mitigations that may also help protect against this and similar vulnerabilities. |
